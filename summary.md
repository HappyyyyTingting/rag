#### RAG简介
RAG(Retrieval Augmented Generation)技术是一种结合**检索（Retrieval)**和**生成（Generation)**的自然处理方法，旨在提高基于生成模型的问答系统效果。
它通过从一个外部知识库（或文档集合）中检索出相关内容，再结合生成模型生成基于上下文的回答，从而提升生成的准确性和信息丰富度。

**RAG工作流程**：
1. **用户输入问题**
2. **检索模块**将用户输入转化为向量表示或其他查询形式，检索出相关的段落或文档。
3. **生成模块**根据检索出的内容和用户问题作为输入，生成最终的答案。
4. **返回答案**给用户

**RAG关键组成**：
1. **知识库构建**：

   专业知识文件(如pdf, word等)进行向量化表示，然后进行存储构建专业知识库。
   - **数据预处理**：
        专业知识文件进行向量化表示前通常需要进行数据预处理（清洗其中的噪声）
        - 去处无关信息（如HTML标签，冗余符号等）
        - 去除多语言或特殊字符（如标点符号、表情符号等）
        - 分割长文本为小块内容（段落、句子）以便后续进行向量化表示，以及解决大模型token限制问题。
   - **向量化表示**：
        将文本数据转化为向量（Embedding)。常用的Embedding模型有：BERT、GPT等模型。
   - **存储与检索**：
        - 存储形式：知识库的数据和向量可以存储在不同类型的数据库中。比如关系型数据库、非关系型数据库和专用的向量数据库等。
        - 向量索引：为加速检索，使用向量索引结构（如HNSW、IVF)对知识库进行索引。
   - **知识库跟新与维护**
2. **知识库检索**：

   根据用户查询，将查询问题向量化，并检索出最相关的文档。检索过程的关键是如何构建检索策略检索出最相关的知识片段（简单的检索策略有KNN，余弦相似度等方式）
3. **智能问答**：
    
    将步骤2检索的知识片段和用户问题向量通过一定形式进行组合（也就是设计prompt模板），使用prompt进行处理后的文本一起作为输入传递给语言模型生成回答。
**RAG优势**：

   通过结合外部知识库，可以增强模型的知识覆盖面，使得模型不仅具有通用知识还具备特定领域的知识。这样生成模型在回答问题时可以基于这些上下文生成更加准确的答案。

**RAG应用场景**：
- **问答系统**：通过检索外部知识库中的信息并生成答案，为用户提供基于事实的回答。
- **客服服务**：结合已有的文档、FAQ知识文档生成客户支持回答。
- **文档摘要**：从大量文档中提取关键信息，生成简明的摘要或者总结。

### 总结与思考
各阶段难点及解决方案：
1. 知识库构建过程难点：
    - **文本提取过程**：
      - **文档格式多样**：
        
          PPT、Word、pdf等文档的格式差异较大，它们并不是纯文本格式，尤其是pdf和ppt通常是以图像和矢量图的方式进行存储内容。这使得简单的文本提取方法难以有效工作。
          对于不同文档格式，常见的解析库有：
            
          PDF: `PyMuPDF`,`pdfminer`,`PyPDF2`等专业库可以解析pdf文档并提取文本。
        
          Word: `python-docx`可以解析`.docx`格式的word文档，可以方便提取文本内容。
        
          PPT: `python-pptx`可以提取ppt内的内容。
        
          对于混合了图像和文本的文件，可以结合OCR技术来提取嵌入图片中的格式。
      - **文档结构复杂**：
      
          复杂的文档包含标题、表格、图片、文本等内容元素，这些元素的布局、顺序、层次结构和格式信息对文档的理解很重要，需要通过特定的方式保留这些结构关系。
        - 保持层次结构
        - 文本与图片的关联
        - 表格内容处理
        - 元数据保留
      - **内容切分粒度**：
        
        如何对提取的文本进行合理的切分也是一个难点。制定一个合理的切分粒度很重要，如果切分粒度过小，则信息的连贯性或受到影响，如果切分的粒度过大，用户的查询可能无法匹配到相关信息。
        一些常见的切分策略：
        - 基于段落和标题进行切分：利用文档的标题和段落进行初步分段，并根据内容的逻辑关系进一步细化切分。
        - 基于句子的切分：对文本进行句子级别切分，以保证语义完整性。
        - 内容摘要：对于较长的段落，可以使用文本摘要技术，生成简短的片段用于知识库中的存储。
      - **性能问题**：
        
        在对于大型文档直接提取整个文件内容可能会导致性能问题：比如内存占用过高、提取速度慢等问题。常见的解决方案有：
        - 逐页提取：对于大型文档，可以通过主页提取来处理，减少内存占用，并分批处理数据。
        - 批处理：将文档分块处理，通过异步或多线程技术提升处理效率
        - 优化库选择：选择高效的解析库，比如`PyMuPDF`提供较快的PDF处理速度。
      
    在上述的几个知识库构建过程可能遇到的问题中，内容切分粒度和如何处理保持文档结构和业务联系比较紧密。
    - **存储过程**：
      
        向量数据库存储过程可能遇到性能、存储空间、数据一致性、更新效率等多方面的问题。可以采取索引优化、数据压缩、增量更新、分布式等方法进行解决。
2. 知识库检索过程难点：
        知识库检索过程主要体现在效率与精度的平衡、复杂查询的处理、多模态与多语言支持、多义性与上下文关联等问题。

3. 生成过程难点：
        在确定基座模型后，生成结果的质量主要取决于如何使用检索到的知识和问题构建prompt，约束生成的回答。

总结一下，上述过程遇到的问题，可以总结为**规模问题**和**生成内容质量问题**。其中规模问题主要在于如何应对大规模数据的存储、检索和系统性能的问题。而生成内容质量主要在于如何应对提高生成高质量的回答，包括准确性、多样性、连贯性和伦理性等问题。
规模问题更多地与通用系统架构和性能优化相关，与具体领域无关；而生成内容质量问题则直接关系到如何在特定垂直领域生成符合行业要求的回答，领域依赖性较强。这意味着生成内容质量问题和业务的联系更加紧密，必须考虑具体行业的需求和规范，而规模问题则是较为通用的技术性挑战。

